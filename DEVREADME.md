
# ARCH DIAGRAMS Contributors

_Architecture diagrams for **Joint EX FLYTRAP / VANAHEIM**_

[![Draw.io diagram check](https://github.com/dlf-dds/FLYTRAP-ALL-ARCH/actions/workflows/diagrams.yml/badge.svg)](https://github.com/dlf-dds/FLYTRAP-ALL-ARCH/actions/workflows/diagrams.yml)

## üèÉ‚Äç‚ôÇÔ∏è  **Quick-start for non-developers**

Want to share a diagram but don‚Äôt care about Docker, Git hooks, or LFS?  
No problem‚Äî**just create a folder for your work and upload your `.drawio` file (plus any notes) right from the GitHub web UI.**

<details>
<summary><strong>Web-UI upload in&nbsp;~60 seconds ‚åö</strong></summary>

1. **Open the repo in your browser**  
   `https://github.com/dlf-dds/FLYTRAP-ALL-ARCH`

2. **Navigate (or create) a sub-folder that matches your area**  
   *Examples:*  
   `Baseline/`, `Sensors/`, `Romania-Edge/`, `MyTeam-2025Q3/`  
   > Use clear names so others can find your work.

3. **Add your files**  
   * Click **Add file ‚ñ∏ Upload files** (top-right).  
   * Drag-and-drop your `*.drawio` file and any `.md`/`.txt` documentation.  
   * (Optional) If you already exported a PNG, drop it in too; otherwise our CI will generate one later.

4. **Commit**  
   * Scroll down, enter a short description (‚ÄúAdd EW-pipeline diagram‚Äù) and press **Commit changes**.  
   * That‚Äôs it‚Äîno local Git setup required.

</details>

### What happens next?

* A PNG preview will be auto-generated by CI so others can view the diagram without Draw.io.  
* You can always edit or replace the file later through the same **Add file** ‚Üí **Upload files** path (or use **Edit** to tweak text docs).

> **Tip:** If you ever decide to do deeper work (automation, hooks, etc.), come back and follow the full **Dev README** below. Until then, the web UI route is perfectly fine.

----
## Developer's README

## Prerequisites

- [Docker](https://docs.docker.com/)  
  Runs the Draw.io CLI without installing the desktop app
- Git ‚â• 2.9  
  Needed for `core.hooksPath`
- Git LFS  
  Stores every `.png` in the lightweight LFS store instead of bloating the repo



## First-time setup

Pull the Draw.io CLI container:

```sh
# Pull the Docker CLI (recommended)
docker pull rlespinasse/drawio-export
# One-time LFS initialisation on your machine
git lfs install
```

This Makefile, in the project root dir, renders .drawio to .png files.

```makefile
# root-level Makefile ‚Äì works for any depth, single or multi-page diagrams

DRAWIO_IMAGE = rlespinasse/drawio-export
# We‚Äôll launch the container with "-v $(PWD):/workspace"
# and then "-w /workspace/<diagram-dir>" for each file.

# list changed *.drawio that still exist in HEAD
DRAWIOS=$(git diff --name-only --diff-filter=AM "$BASE" HEAD -- '*.drawio')

PNGS    := $(DRAWIOS:.drawio=.png)

all: $(PNGS)

# target $@  : diagrams/foo.png
# source $<  : diagrams/foo.drawio
%.png: %.drawio
	@SRC='$<';           \
	  DIR=$$(dirname "$$SRC");                    \
	  NAME=$$(basename "$$SRC" .drawio);          \
	  echo "Exporting $$SRC ‚Üí $@";                \
	  docker run --rm                             \
	    -v "$(PWD)":/workspace                    \
	    -w "/workspace/$$DIR"                     \
	    $(DRAWIO_IMAGE)                           \
	    -f png -o . "$$NAME.drawio" &&            \
	  (                                           \
	    mv "$$DIR/$$NAME-Page-1.png" "$@" 2>/dev/null || \
	    mv "$$DIR/$$NAME.png"        "$@" 2>/dev/null     \
	  )


```

## Keeping diagrams fresh ‚òÖ **Important**

Every `.drawio` source **must** have a matching, up-to-date `.png` next to it.
The PNGs are what non-Draw.io users (and GitHub‚Äôs preview) rely on.

| How to stay green | What it does |
|-------------------|--------------|
| **Preferred**<br>Just commit normally ‚Äì the **`pre-commit` hook** auto-exports fresh PNGs for any staged `.drawio` files and stages them for you. | Fast, fool-proof. |
| **Manual**<br>`make path/to/diagram.png` (or simply `make` when in that folder) then `git add` the PNG. | Use if you skip hooks with `--no-verify`. |

The badge at the top of the README shows the most-recent **CI run**:

[![Draw.io diagram check](https://github.com/dlf-dds/FLYTRAP-ALL-ARCH/actions/workflows/diagrams.yml/badge.svg)](https://github.com/dlf-dds/FLYTRAP-ALL-ARCH/actions/workflows/diagrams.yml)

* **Green** ‚áí every PNG byte-for-byte matches the diagram it was generated from.  
* **Red**   ‚áí at least one PNG is missing or stale. CI tells you which file(s)‚Äîre-export, commit, push.

> **Under the hood**  
> * Locally, `make` only runs when the diagram‚Äôs timestamp is newer than its PNG.  
> * In CI we force-rebuild just the diagrams changed in the push (`make -B`) and compare file contents with `git diff`. Timestamps alone don‚Äôt pass the test‚ÄîPNG bytes must be identical.

---

### Git Settings
Place this in `.gitattributes` to ensure proper handling of the `.drawio` files and their binary exports:

```gitattributes
# Draw.io sources ‚Üí XML diff
*.drawio diff=xml

# PNGs travel via Git LFS
*.png filter=lfs diff=lfs merge=lfs -text

```


### Git hooks

```sh
# Activate repo-local hooks
git config core.hooksPath .githooks

# Ensure the pre-commit script is executable
chmod +x .githooks/pre-commit
```

The `pre-commit` hook re-exports any staged `.drawio` files to matching `.pngs` and re-adds them to the commit.

See `.githooks/pre-commit` for the full script that calls `make` on staged diagrams.


### CI safety net

> **Tip:** Our GitHub Actions workflow re-exports every diagram and fails the build if a pushed `.png` is out of date. Run `make` (or rely on the pre-commit hook) before committing to keep your PR green.

See `.github/workflows/diagrams.yml` for the exact CI check.

CI rebuilds only the diagrams changed in a push/PR (using make -B ‚Ä¶targets‚Ä¶) so runs stay quick even in large repos.
